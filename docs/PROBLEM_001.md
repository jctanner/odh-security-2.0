# Problem 001: NETWORK_MODE Not Propagated to Notebook Controller

## Summary

When the `DataScienceClusterInitialization` (DSCI) resource is configured with `spec.networking.mode: gateway-api`, the `opendatahub-operator` fails to propagate the `NETWORK_MODE=gateway-api` environment variable to the `odh-notebook-controller-manager` pod.

As a result, the notebook controller defaults to its standard networking behavior:
*   It injects an `oauth-proxy` sidecar instead of the expected `debug-proxy`.
*   It does not create an `HTTPRoute` resource for the workbench.

This occurs even after fixing RBAC permissions for the operator and forcing a reconciliation by deleting the `Workbenches` custom resource.

## Root Cause Analysis

The root cause of this issue is a design flaw in how the `dscinitialization-controller` communicates configuration changes to the `workbenches-controller` within the `opendatahub-operator`.

1.  **Incorrect Modification Strategy**: The `dscinitialization-controller` reads the `networking.mode` from the `DSCI` resource and attempts to apply this configuration by modifying a `params.env` file located in its own container's filesystem at `/opt/manifests/workbenches/odh-notebook-controller/base/params.env`.

2.  **No Dynamic Manifest Reload**: The `workbenches-controller`, which runs in the same operator process, reads the component manifests from the `/opt/manifests` directory at startup. It does not monitor these files for changes. Therefore, any runtime modifications made by the `dscinitialization-controller` to the `params.env` file are ignored.

3.  **Incomplete Kustomization**: The Kustomize build for the `odh-notebook-controller`, defined in `.../base/kustomization.yaml`, was only configured to use the `params.env` file to set the controller's container *image*. It lacked a mechanism to take other values from the generated `ConfigMap` (like `NETWORK_MODE`) and inject them as environment variables into the controller's `Deployment`.

Essentially, the two controllers are not communicating effectively. The `dscinitialization-controller` writes a configuration change to a file that the `workbenches-controller` has already finished reading.

## Solution: Manifest-Based Injection

Since the `dscinitialization-controller` successfully updates the `params.env` file, the most direct solution is to fix the Kustomize manifests to correctly use the values generated from that file. This ensures that when the `opendatahub-operator` deploys the notebook controller, Kustomize correctly builds the deployment with the required environment variable.

The fix involves two changes to the operator's source manifests:

1.  **Add a Placeholder Environment Variable**:
    *   **File**: `./src/opendatahub-operator/opt/manifests/workbenches/odh-notebook-controller/manager/manager.yaml`
    *   **Change**: Add a `NETWORK_MODE` environment variable to the container spec with an empty default value. This provides a target for Kustomize to patch.

    ```yaml
    env:
    - name: NETWORK_MODE
      value: ""
    ```

2.  **Add the Kustomize Replacement Rule**:
    *   **File**: `./src/opendatahub-operator/opt/manifests/workbenches/odh-notebook-controller/base/kustomization.yaml`
    *   **Change**: Add a new `replacement` rule. This rule instructs Kustomize to take the `NETWORK_MODE` value from the `ConfigMap` generated by `params.env` and inject it into the `manager` `Deployment`'s environment variables.

    ```yaml
    replacements:
    # ... (existing image replacement)
    - source:
        fieldPath: data.NETWORK_MODE
        kind: ConfigMap
        name: odh-notebook-controller-image-parameters
        version: v1
      targets:
      - fieldPaths:
        - spec.template.spec.containers.0.env.0.value # Adjust index if needed
        select:
          group: apps
          kind: Deployment
          name: manager
          namespace: system
          version: v1
    ```

After making these changes, the `opendatahub-operator` must be rebuilt and redeployed. The newly deployed operator will then use these corrected manifests to properly configure and launch the `odh-notebook-controller`.
