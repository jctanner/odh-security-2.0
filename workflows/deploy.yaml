name: "Deploy OpenDataHub"
description: "Deploy the full OpenDataHub stack to Kubernetes cluster"

variables:
  NAMESPACE: "opendatahub"
  WAIT_TIMEOUT: "300"

steps:
  - name: "Create namespace"
    type: "kubectl"
    command: "create namespace ${NAMESPACE}"
    ignore_errors: true
    
  - name: "Check if operator already deployed"
    type: "kubectl"
    command: "get deployment opendatahub-operator -n ${NAMESPACE}"
    ignore_errors: true
    
  - name: "Deploy operator"
    type: "kubectl"
    command: "apply -f deployments/operator.yaml -n ${NAMESPACE}"
    
  - name: "Wait for operator to be ready"
    type: "kubectl"
    command: "wait --for=condition=Available deployment/opendatahub-operator -n ${NAMESPACE} --timeout=${WAIT_TIMEOUT}s"
    
  - name: "Deploy DSCI"
    type: "kubectl"
    command: "apply -f deployments/dsci.yaml -n ${NAMESPACE}"
    
  - name: "Wait for DSCI to be ready"
    type: "kubectl"
    command: "wait --for=condition=Ready datascienceclusterinitializations.opendatahub.io/default-dsci -n ${NAMESPACE} --timeout=${WAIT_TIMEOUT}s"
    
  - name: "Deploy DSC"
    type: "kubectl"
    command: "apply"
    args:
      - "-f"
      - "deployments/dsc.yaml"
      - "-n"
      - "${NAMESPACE}"
    
  - name: "Wait for DSC to be ready"
    type: "kubectl"
    command: "wait"
    args:
      - "--for=condition=Ready"
      - "datascienceclusters.opendatahub.io/default-dsc"
      - "-n"
      - "${NAMESPACE}"
      - "--timeout=${WAIT_TIMEOUT}s"
    
  - name: "Check deployment status"
    type: "kubectl"
    command: "get"
    args:
      - "pods"
      - "-n"
      - "${NAMESPACE}"
      - "-o"
      - "wide"
    
  - name: "Show services"
    type: "kubectl"
    command: "get"
    args:
      - "services"
      - "-n"
      - "${NAMESPACE}" 